
/**
 * @fileOverview Firestore Security Rules for Tech Learnings.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data and
 * allows public read access to course-related data, with restricted write
 * access for authorized instructors. It prioritizes authorization independence
 * and structural segregation for secure and maintainable rules.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, accessible only by the user themselves.
 *   The designated instructor can list all users.
 * - /instructors/{instructorId}: Instructor profiles, publicly readable but
 *   writable only by the instructor.
 * - /categories/{categoryId}: Course categories, publicly readable. Write access
 *   is not explicitly defined, implying it should be restricted.
 * - /courses/{courseId}: Course information, publicly readable, but writable
 *   only by the instructor who owns the course.
 * - /classes/{classId}: Recorded classes, publicly readable, but writable
 *   only by the instructor who created it.
 * - /liveSessions/{sessionId}: Live session information, publicly readable,
 *   but only writable by the instructor.
 * - /courses/{courseId}/lectures/{lectureId}: Lectures for each course, inheriting
 *   the access control of the parent course.
 * - /users/{userId}/subscriptions/{subscriptionId}: User subscription information,
 *   accessible only by the user.
 * - /users/{userId}/progress/{progressId}: User course progress, accessible only
 *   by the user.
 *
 * Key Security Decisions:
 * - Users can only access their own data under /users/{userId}.
 * - The designated instructor can list all users for administrative purposes.
 * - Public read access is granted for course-related information.
 * - Instructors can create, update, and delete courses they own.
 * - Listing of non-admin users is disallowed for privacy reasons.
 * - Default deny for any ambiguous or unspecified write operations.
 *
 * Denormalization for Authorization:
 * - Courses denormalize instructorId to enable easy ownership checks without
 *   additional `get()` calls.
 *
 * Structural Segregation:
 * - User-specific data is stored under /users/{userId}, separating it from
 *   public course data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * @description Checks if the authenticated user is the designated instructor for the app.
     * The instructor UID is stored in a document for the rules to access.
     * @returns {boolean} True if the user is the instructor, false otherwise.
     */
    function isAppInstructor() {
        return isSignedIn() && exists(/databases/$(database)/documents/app-config/instructor) &&
               get(/databases/$(database)/documents/app-config/instructor).data.uid == request.auth.uid;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

        /**
     * @description Checks if the authenticated user is the owner and the resource exists.
     * @param {string} userId - The user ID to compare against.
     * @returns {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces that the instructorId of a course or class matches the authenticated user.
     * @returns {boolean} True if the instructorId matches the authenticated user's UID, false otherwise.
     */
    function isResourceInstructor() {
        return isSignedIn() && request.resource.data.instructorId == request.auth.uid;
    }

    /**
     * @description Checks if the authenticated user is the owner of the course (based on instructorId).
     * @param {string} instructorId - The instructor ID of the course.
     * @returns {boolean} True if the user is the instructor, false otherwise.
     */
    function isOwnedByInstructor(instructorId) {
      return isSignedIn() && instructorId == request.auth.uid;
    }

    /**
     * @description
     *  - Allows a user to only access their own profile.
     *  - Allows the designated application instructor to list all users.
     * @path /users/{userId}
     * @allow (get) User with ID 'user123' can get their own profile. (auth.uid: 'user123')
     * @allow (list) The application instructor can list all users.
     * @deny (list) A regular user cannot list all users.
     * @principle Enforces document ownership for most operations, with an exception for admin listing.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if isAppInstructor();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }
    
    /**
     * @description
     *  - A special document to hold the UID of the application instructor.
     *  - Only the currently designated instructor can write to it, but it should rarely change.
     * @path /app-config/instructor
     */
    match /app-config/instructor {
        allow get: if true;
        allow write: if isAppInstructor() || request.auth.uid == request.resource.data.uid;
        allow create: if true;
    }


    /**
     * @description
     *  - Allows anyone to read instructor profiles, but only the instructor can modify their own profile.
     * @path /instructors/{instructorId}
     * @principle Allows public read access with owner-only writes.
     */
    match /instructors/{instructorId} {
      allow get: if true;
      allow list: if false; // Listing instructors is not permitted.
      allow create: if isOwner(instructorId) && request.resource.data.id == instructorId;
      allow update: if isExistingOwner(instructorId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(instructorId);
    }

    /**
     * @description
     *  - Allows anyone to read course categories. Write access is implicitly denied.
     * @path /categories/{categoryId}
     * @principle Allows public read-only access.
     */
    match /categories/{categoryId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description
     *  - Allows anyone to read course information, but only the instructor who owns the course can modify it.
     * @path /courses/{courseId}
     * @principle Allows public read access with owner-only writes.
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if isResourceInstructor();
      allow update: if resource != null && isOwnedByInstructor(resource.data.instructorId);
      allow delete: if resource != null && isOwnedByInstructor(resource.data.instructorId);
    }
    
    /**
     * @description
     *  - Allows anyone to read recorded classes, but only the instructor can create, update, or delete them.
     * @path /classes/{classId}
     * @principle Public read access with owner-only writes.
     */
    match /classes/{classId} {
        allow get: if true;
        allow list: if true;
        allow create: if isResourceInstructor();
        allow update: if resource != null && isOwnedByInstructor(resource.data.instructorId);
        allow delete: if resource != null && isOwnedByInstructor(resource.data.instructorId);
    }

    /**
     * @description
     *  - Allows anyone to read live session details. Only instructors can create them.
     * @path /liveSessions/{sessionId}
     * @principle Public read access with owner-only creation.
     */
    match /liveSessions/{sessionId} {
      allow get: if true;
      allow list: if true;
      allow create: if isResourceInstructor();
      allow update: if false; // Sessions are immutable for now
      allow delete: if false; // Deletions should be handled by a backend process
    }

    /**
     * @description
     *  - Allows anyone to read lecture information, but only the instructor who owns the course can modify it.
     *  - Inherits access control from the parent Course entity.
     * @path /courses/{courseId}/lectures/{lectureId}
     * @principle Inherits access control from the parent Course entity.
     */
    match /courses/{courseId}/lectures/{lectureId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid;
        allow update: if isSignedIn() && get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid;
        allow delete: if isSignedIn() && get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid;
    }

    /**
     * @description
     *  - Allows a user to only access their own subscription information.
     * @path /users/{userId}/subscriptions/{subscriptionId}
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/subscriptions/{subscriptionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description
     *  - Allows a user to only access their own course progress information.
     * @path /users/{userId}/progress/{progressId}
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/progress/{progressId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}
